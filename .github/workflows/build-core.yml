name: Reusable Build

on:
  workflow_dispatch:
    inputs:
      run_tests:
        description: "Run test job"
        type: boolean
        required: false
        default: true
      build_macos_arm64:
        description: "Build macOS ARM64"
        type: boolean
        required: false
        default: true
      build_macos_amd64:
        description: "Build macOS AMD64"
        type: boolean
        required: false
        default: true
      build_windows_amd64:
        description: "Build Windows AMD64"
        type: boolean
        required: false
        default: true
      build_linux_amd64:
        description: "Build Linux AMD64"
        type: boolean
        required: false
        default: true
      require_macos_notarize:
        description: "Require macOS signing + notarization (needs MACOS_* and APPLE_API_* secrets)"
        type: boolean
        required: false
        default: false
      require_windows_signpath:
        description: "Require Windows SignPath signing (needs SIGNPATH_* secrets)"
        type: boolean
        required: false
        default: false
      artifact_retention_days:
        description: "Artifacts retention days"
        type: number
        required: false
        default: 10
  workflow_call:
    inputs:
      run_tests:
        type: boolean
        required: false
        default: true
      build_macos_arm64:
        type: boolean
        required: false
        default: true
      build_macos_amd64:
        type: boolean
        required: false
        default: true
      build_windows_amd64:
        type: boolean
        required: false
        default: true
      build_linux_amd64:
        type: boolean
        required: false
        default: true
      require_macos_notarize:
        type: boolean
        required: false
        default: false
      require_windows_signpath:
        type: boolean
        required: false
        default: false
      artifact_retention_days:
        type: number
        required: false
        default: 10
    secrets:
      MACOS_KEYCHAINPWD:
        required: false
      MACOS_SIGN_P12_BASE64:
        required: false
      MACOS_SIGN_P12_PASSWORD:
        required: false
      MACOS_SIGN_IDENTITY:
        required: false
      APPLE_API_KEY_ID:
        required: false
      APPLE_API_ISSUER_ID:
        required: false
      APPLE_API_PRIVATE_KEY_P8_BASE64:
        required: false
      SIGNPATH_API_TOKEN:
        required: false
      SIGNPATH_ORGANIZATION_ID:
        required: false

permissions:
  contents: read
  id-token: write
  attestations: write

jobs:
  test:
    if: ${{ inputs.run_tests }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install system dependencies (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang \
            cmake \
            ninja-build \
            pkg-config \
            libgtk-3-dev \
            libblkid-dev \
            liblzma-dev \
            libsecret-1-dev \
            libglib2.0-dev \
            libgirepository1.0-dev \
            libx11-dev \
            libx11-xcb-dev \
            libxext-dev \
            libxfixes-dev \
            libxi-dev \
            libxinerama-dev \
            libxrandr-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-dev \
            libxcursor-dev \
            libxtst-dev \
            libayatana-appindicator3-dev \
            libkeybinder-3.0-dev \
            libfuse2 \
            xvfb
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: wox.core/go.mod
          cache: true
      # - name: Test
      #   run: xvfb-run -a make test

  build_macos_arm64:
    name: Build macOS ARM64
    needs: test
    if: ${{ always() && inputs.build_macos_arm64 && (!inputs.run_tests || needs.test.result == 'success') }}
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: wox.core/go.mod
          cache: true
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8.15.5
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: |
            wox.plugin.host.nodejs/pnpm-lock.yaml
            wox.plugin.nodejs/pnpm-lock.yaml
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Setup uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - name: Install create-dmg
        run: brew install create-dmg
      - name: Enable Flutter desktop (macOS)
        run: flutter config --enable-macos-desktop

      - name: Validate macOS signing/notarization secrets
        if: ${{ inputs.require_macos_notarize }}
        env:
          MACOS_KEYCHAINPWD: ${{ secrets.MACOS_KEYCHAINPWD }}
          MACOS_SIGN_P12_BASE64: ${{ secrets.MACOS_SIGN_P12_BASE64 }}
          MACOS_SIGN_P12_PASSWORD: ${{ secrets.MACOS_SIGN_P12_PASSWORD }}
          MACOS_SIGN_IDENTITY: ${{ secrets.MACOS_SIGN_IDENTITY }}
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
          APPLE_API_PRIVATE_KEY_P8_BASE64: ${{ secrets.APPLE_API_PRIVATE_KEY_P8_BASE64 }}
        run: |
          set -euo pipefail
          for v in MACOS_KEYCHAINPWD MACOS_SIGN_P12_BASE64 MACOS_SIGN_P12_PASSWORD MACOS_SIGN_IDENTITY APPLE_API_KEY_ID APPLE_API_ISSUER_ID APPLE_API_PRIVATE_KEY_P8_BASE64; do
            if [ -z "${!v:-}" ]; then
              echo "Missing required secret: $v" >&2
              exit 1
            fi
          done

      - name: Setup macOS signing keychain
        if: ${{ inputs.require_macos_notarize }}
        env:
          MACOS_KEYCHAINPWD: ${{ secrets.MACOS_KEYCHAINPWD }}
          MACOS_SIGN_P12_BASE64: ${{ secrets.MACOS_SIGN_P12_BASE64 }}
          MACOS_SIGN_P12_PASSWORD: ${{ secrets.MACOS_SIGN_P12_PASSWORD }}
        run: |
          set -euo pipefail
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          CERT_PATH="$RUNNER_TEMP/signing_cert.p12"

          echo "$MACOS_SIGN_P12_BASE64" | base64 --decode > "$CERT_PATH"

          security create-keychain -p "$MACOS_KEYCHAINPWD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$MACOS_KEYCHAINPWD" "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH"

          security import "$CERT_PATH" -k "$KEYCHAIN_PATH" -P "$MACOS_SIGN_P12_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$MACOS_KEYCHAINPWD" "$KEYCHAIN_PATH"

      - name: Configure notarization (App Store Connect API Key)
        if: ${{ inputs.require_macos_notarize }}
        env:
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
          APPLE_API_PRIVATE_KEY_P8_BASE64: ${{ secrets.APPLE_API_PRIVATE_KEY_P8_BASE64 }}
        run: |
          set -euo pipefail
          API_KEY_PATH="$RUNNER_TEMP/AuthKey.p8"
          echo "$APPLE_API_PRIVATE_KEY_P8_BASE64" | base64 --decode > "$API_KEY_PATH"
          xcrun notarytool store-credentials wox \
            --key "$API_KEY_PATH" \
            --key-id "$APPLE_API_KEY_ID" \
            --issuer "$APPLE_API_ISSUER_ID"

      - name: Build
        run: make build
        env:
          MACOS_KEYCHAINPWD: ${{ inputs.require_macos_notarize && secrets.MACOS_KEYCHAINPWD || '' }}
          MACOS_SIGN_IDENTITY: ${{ inputs.require_macos_notarize && secrets.MACOS_SIGN_IDENTITY || '' }}

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: ./release/wox-mac-arm64.dmg

      - name: Staple and validate dmg
        if: ${{ inputs.require_macos_notarize }}
        run: |
          set -euo pipefail
          xcrun stapler staple ./release/wox-mac-arm64.dmg
          spctl -a -vv -t install ./release/wox-mac-arm64.dmg

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wox-mac-arm64.dmg
          path: ./release/wox-mac-arm64.dmg
          retention-days: ${{ inputs.artifact_retention_days }}

  build_macos_amd64:
    name: Build macOS AMD64
    needs: test
    if: ${{ always() && inputs.build_macos_amd64 && (!inputs.run_tests || needs.test.result == 'success') }}
    runs-on: macos-15-intel
    steps:
      - uses: actions/checkout@v3
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: wox.core/go.mod
          cache: true
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8.15.5
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: |
            wox.plugin.host.nodejs/pnpm-lock.yaml
            wox.plugin.nodejs/pnpm-lock.yaml
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Setup uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - name: Install create-dmg
        run: brew install create-dmg
      - name: Enable Flutter desktop (macOS)
        run: flutter config --enable-macos-desktop

      - name: Validate macOS signing/notarization secrets
        if: ${{ inputs.require_macos_notarize }}
        env:
          MACOS_KEYCHAINPWD: ${{ secrets.MACOS_KEYCHAINPWD }}
          MACOS_SIGN_P12_BASE64: ${{ secrets.MACOS_SIGN_P12_BASE64 }}
          MACOS_SIGN_P12_PASSWORD: ${{ secrets.MACOS_SIGN_P12_PASSWORD }}
          MACOS_SIGN_IDENTITY: ${{ secrets.MACOS_SIGN_IDENTITY }}
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
          APPLE_API_PRIVATE_KEY_P8_BASE64: ${{ secrets.APPLE_API_PRIVATE_KEY_P8_BASE64 }}
        run: |
          set -euo pipefail
          for v in MACOS_KEYCHAINPWD MACOS_SIGN_P12_BASE64 MACOS_SIGN_P12_PASSWORD MACOS_SIGN_IDENTITY APPLE_API_KEY_ID APPLE_API_ISSUER_ID APPLE_API_PRIVATE_KEY_P8_BASE64; do
            if [ -z "${!v:-}" ]; then
              echo "Missing required secret: $v" >&2
              exit 1
            fi
          done

      - name: Setup macOS signing keychain
        if: ${{ inputs.require_macos_notarize }}
        env:
          MACOS_KEYCHAINPWD: ${{ secrets.MACOS_KEYCHAINPWD }}
          MACOS_SIGN_P12_BASE64: ${{ secrets.MACOS_SIGN_P12_BASE64 }}
          MACOS_SIGN_P12_PASSWORD: ${{ secrets.MACOS_SIGN_P12_PASSWORD }}
        run: |
          set -euo pipefail
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          CERT_PATH="$RUNNER_TEMP/signing_cert.p12"

          echo "$MACOS_SIGN_P12_BASE64" | base64 --decode > "$CERT_PATH"

          security create-keychain -p "$MACOS_KEYCHAINPWD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$MACOS_KEYCHAINPWD" "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH"

          security import "$CERT_PATH" -k "$KEYCHAIN_PATH" -P "$MACOS_SIGN_P12_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$MACOS_KEYCHAINPWD" "$KEYCHAIN_PATH"

      - name: Configure notarization (App Store Connect API Key)
        if: ${{ inputs.require_macos_notarize }}
        env:
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
          APPLE_API_PRIVATE_KEY_P8_BASE64: ${{ secrets.APPLE_API_PRIVATE_KEY_P8_BASE64 }}
        run: |
          set -euo pipefail
          API_KEY_PATH="$RUNNER_TEMP/AuthKey.p8"
          echo "$APPLE_API_PRIVATE_KEY_P8_BASE64" | base64 --decode > "$API_KEY_PATH"
          xcrun notarytool store-credentials wox \
            --key "$API_KEY_PATH" \
            --key-id "$APPLE_API_KEY_ID" \
            --issuer "$APPLE_API_ISSUER_ID"

      - name: Build
        run: make build
        env:
          MACOS_KEYCHAINPWD: ${{ inputs.require_macos_notarize && secrets.MACOS_KEYCHAINPWD || '' }}
          MACOS_SIGN_IDENTITY: ${{ inputs.require_macos_notarize && secrets.MACOS_SIGN_IDENTITY || '' }}

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: ./release/wox-mac-amd64.dmg

      - name: Staple and validate dmg
        if: ${{ inputs.require_macos_notarize }}
        run: |
          set -euo pipefail
          xcrun stapler staple ./release/wox-mac-amd64.dmg
          spctl -a -vv -t install ./release/wox-mac-amd64.dmg

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wox-mac-amd64.dmg
          path: ./release/wox-mac-amd64.dmg
          retention-days: ${{ inputs.artifact_retention_days }}

  build_windows_amd64:
    name: Build Windows AMD64
    needs: test
    if: ${{ always() && inputs.build_windows_amd64 && (!inputs.run_tests || needs.test.result == 'success') }}
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install make (Windows)
        shell: pwsh
        run: choco install -y make

      - name: Validate SignPath secrets
        if: ${{ inputs.require_windows_signpath }}
        env:
          SIGNPATH_API_TOKEN: ${{ secrets.SIGNPATH_API_TOKEN }}
          SIGNPATH_ORGANIZATION_ID: ${{ secrets.SIGNPATH_ORGANIZATION_ID }}
        shell: bash
        run: |
          set -euo pipefail
          for v in SIGNPATH_API_TOKEN SIGNPATH_ORGANIZATION_ID; do
            if [ -z "${!v:-}" ]; then
              echo "Missing required secret: $v" >&2
              exit 1
            fi
          done

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: wox.core/go.mod
          cache: true

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8.15.5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: |
            wox.plugin.host.nodejs/pnpm-lock.yaml
            wox.plugin.nodejs/pnpm-lock.yaml

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Enable Flutter desktop (Windows)
        shell: pwsh
        run: flutter config --enable-windows-desktop

      - name: Build
        shell: bash
        run: make build

      - name: Upload unsigned artifact (Windows)
        id: upload-unsigned-artifact
        if: ${{ inputs.require_windows_signpath }}
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-wox-windows-amd64.exe
          path: ./release/wox-windows-amd64.exe
          retention-days: 1

      - name: Sign with SignPath (Windows)
        if: ${{ inputs.require_windows_signpath }}
        uses: signpath/github-action-submit-signing-request@v2
        with:
          api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
          organization-id: ${{ secrets.SIGNPATH_ORGANIZATION_ID }}
          project-slug: Wox
          signing-policy-slug: test-signing
          github-artifact-id: ${{ steps.upload-unsigned-artifact.outputs.artifact-id }}
          wait-for-completion: true
          output-artifact-directory: ./release

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: ./release/wox-windows-amd64.exe

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wox-windows-amd64.exe
          path: ./release/wox-windows-amd64.exe
          retention-days: ${{ inputs.artifact_retention_days }}

  build_linux_amd64:
    name: Build Linux AMD64
    needs: test
    if: ${{ always() && inputs.build_linux_amd64 && (!inputs.run_tests || needs.test.result == 'success') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang \
            cmake \
            ninja-build \
            pkg-config \
            libgtk-3-dev \
            libblkid-dev \
            liblzma-dev \
            libsecret-1-dev \
            libglib2.0-dev \
            libgirepository1.0-dev \
            libx11-dev \
            libx11-xcb-dev \
            libxext-dev \
            libxfixes-dev \
            libxi-dev \
            libxinerama-dev \
            libxrandr-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-dev \
            libxcursor-dev \
            libxtst-dev \
            libayatana-appindicator3-dev \
            libkeybinder-3.0-dev \
            xvfb
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: wox.core/go.mod
          cache: true
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8.15.5
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: |
            wox.plugin.host.nodejs/pnpm-lock.yaml
            wox.plugin.nodejs/pnpm-lock.yaml
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Setup uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - name: Enable Flutter desktop (Linux)
        run: flutter config --enable-linux-desktop
      - name: Download appimagetool
        run: |
          curl -L -o appimagetool.AppImage https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool.AppImage
      - name: Build
        run: xvfb-run -a make build
        env:
          APPIMAGE_TOOL: ./appimagetool.AppImage
      - name: Attest build provenance
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: ./release/wox-linux-amd64
      - name: Attest AppImage provenance
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: ./release/wox-linux-amd64.AppImage
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wox-linux-amd64
          path: ./release/wox-linux-amd64
          retention-days: ${{ inputs.artifact_retention_days }}
      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: wox-linux-amd64.AppImage
          path: ./release/wox-linux-amd64.AppImage
          retention-days: ${{ inputs.artifact_retention_days }}
